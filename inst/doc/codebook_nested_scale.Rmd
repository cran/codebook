---
title: "Codebook example with nested scales"
author: "Ruben Arslan"
date: "`r Sys.Date()`"
output:
  html_vignette:
    fig_width: 7
    fig_height: 6
vignette: >
  %\VignetteIndexEntry{Example with nested scales}
  \%VignetteKeyword{nested}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r message = FALSE}
knit_by_pkgdown <- !is.null(knitr::opts_chunk$get("fig.retina"))
knitr::opts_chunk$set(warning = TRUE, message = TRUE, error = TRUE, echo = TRUE)
pander::panderOptions("table.split.table", Inf)
ggplot2::theme_set(ggplot2::theme_bw())
library(codebook)
library(dplyr)
data("bfi", package = 'codebook')
```

Sometimes, we have scales that incorporate other scales. For example, some researchers
derive the "Big Two" Alpha and Beta can be derived by averaging the lower-order
"Big Five". Here, we just demonstrate how additional scales relying on the same
items as lower-order scales can be added in the codebook package. The procedure 
is the same, irrespective of whether scales already exist. We use the same
mock BFI dataset from the main vignette here.

Here, we use the function `aggregate_and_document_scale` to build the "alpha"
scale. We assign `alpha` to a new colum in the data frame and we pass the constituent
items as a data.frame to the function on the right-hand side. Because alpha
relates to emotional stability, not neuroticism, we reverse the neuroticism
items before averaging them with the rest.

```{r}
bfi$alpha <- aggregate_and_document_scale(bfi %>% 
  select(starts_with("BFIK_agree_"), starts_with("BFIK_consc_"), starts_with("BFIK_neuro_")) %>% 
  mutate_at(vars(starts_with("BFIK_neuro_")), reverse_labelled_values))
```

Alternatively, we can do the same thing using dplyr syntax. Because of some limitation
in the dplyr syntax, we either explicitly name the data frame and pipe it in,
or we choose not to pipe it and can use the shorthand `.` to refer to the currently
used data frame.

```{r}
bfi <- bfi %>% mutate(
  alpha = aggregate_and_document_scale(bfi %>% 
  select(starts_with("BFIK_agree_"), starts_with("BFIK_consc_"), starts_with("BFIK_neuro_")) %>% 
  mutate_at(vars(starts_with("BFIK_neuro_")), reverse_labelled_values)
))

bfi <- bfi %>% mutate(beta = aggregate_and_document_scale(select(. ,
  starts_with("BFIK_extra_"), starts_with("BFIK_open_"))))
```

We then use the function `var_label` from the `labelled` package to give the 
scale an informative name, because the default name is just the common stem of
the aggregated items. In this case, that would be the misleading abbreviation BFIK.
```{r}
library(labelled)
var_label(bfi$alpha) # old name
var_label(bfi$alpha) <- "Alpha: higher order personality factor (consc, neuro, agree)"
var_label(bfi$beta) <- "Beta: higher order personality factor (extra, open)"
```

To keep things short, we omit the alpha scale.
```{r}
bfi <- bfi %>% select(beta, starts_with("BFIK_extra"), starts_with("BFIK_open"))
if (!knit_by_pkgdown) knitr::opts_chunk$set(echo = FALSE)
```



```{r cb}
codebook(bfi, survey_repetition = 'single',
         metadata_table = knit_by_pkgdown, metadata_json = knit_by_pkgdown)
```


`r ifelse(knit_by_pkgdown, '', '### Codebook table')`

```{r}
if (!knit_by_pkgdown) {
  codebook:::escaped_table(codebook_table(bfi))
}
```
